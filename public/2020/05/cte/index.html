<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>SQLite Helper Queries | AlecStrong</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noodp" />
<meta name="Description" content="">
<link rel="prev" href="https://alecstrong.com/2020/02/multiple-dialects/" />
<link rel="canonical" href="https://alecstrong.com/2020/05/cte/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SQLite Helper Queries"/>
<meta name="twitter:description" content="In programming one of the earliest tools we&#39;re given for simplifying complex code is helper functions. Splitting code into smaller more digestible blocks makes it easier to maintain and read, which is usually more important than code that&#39;s easier to write. In SQL we have tools for accomplishing the same thing! One of the bigger ones is views which can help share an underlying query between multiple other ones. Leandro Favarin wrote a great post on how to put views into practice in SQLite here."/>
<script type="application/ld+json">
    {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "SQLite Helper Queries",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https:\/\/alecstrong.com\/2020\/05\/cte\/"
    },

    "genre": "posts",

    "wordcount":  780 ,
    "url": "https:\/\/alecstrong.com\/2020\/05\/cte\/",

        "datePublished": "2020-05-13T21:31:03-04:00",


        "dateModified": "2020-05-13T21:31:03-04:00",


        "license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.",



    "description": ""
    }
    </script>
<link rel="stylesheet" href="/css/style.min.css">
<link rel="stylesheet" href="/css/lib/fontawesome-free/all.min.min.css">

<link rel="stylesheet" href="/css/lib/animate/animate.min.min.css">

    </head>
    <body>
        <script>
            window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            window.isDark && document.body.classList.add('dark-theme');
        </script>
        <div class="wrapper">
            <nav class="navbar">
    <div class="navbar-container">
        <div class="navbar-header animated bounceIn">
            <a href="https://alecstrong.com/">AlecStrong</a>
        </div>
        <div class="navbar-menu">


                <a class="menu-item" href="https://alecstrong.com/posts" title="">Posts</a>

                <a class="menu-item" href="https://alecstrong.com/talks" title="">Talks</a>

            <a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a>
        </div>
    </div>
</nav>
<nav class="navbar-mobile">
     <div class="navbar-container">
        <div class="navbar-header">
            <div class="navbar-header-title animated bounceIn">
                <a href="https://alecstrong.com/">AlecStrong</a>
            </div>
            <div class="menu-toggle" id="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="navbar-menu" id="mobile-menu">


                <a class="menu-item" href="https://alecstrong.com/posts" title="">Posts</a>

                <a class="menu-item" href="https://alecstrong.com/talks" title="">Talks</a>

            <a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a>
        </div>
    </div>
</nav><main class="main">
                <div class="container">





    <article class="post-warp">
        <h1 class="post-title animated flipInX">SQLite Helper Queries</h1>

        <div class="post-meta">
            <div class="post-meta-main">
                <a class="author" href="https://alecstrong.com/" rel="author"><i class="fas fa-user-circle fa-fw"></i>Alec Strong&nbsp;</a>

            </div>
            <div class="post-meta-other">
                <i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-05-13>2020-05-13</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>about 780 words&nbsp;
                <i class="far fa-clock fa-fw"></i>4 min&nbsp;</div>
        </div>





        <div class="post-content">

























            <p>In programming one of the earliest tools we're given for simplifying complex code is helper functions.
Splitting code into smaller more digestible blocks makes it easier to maintain and read, which is
usually more important than code that's easier to write. In SQL we have tools for accomplishing
the same thing! One of the bigger ones is views which
can help share an underlying query between multiple other ones. Leandro Favarin wrote a great
post on how to put views into practice in SQLite <a href="https://leandrofavarin.com/sqldelight-powerful-codegen">here</a>.</p>
<p>Another strategy for simplifying a query is common table expressions. Take for example a query like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">album</span>
<span class="k">WHERE</span> <span class="n">year_of_release</span> <span class="o">=</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">year_of_release</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">album</span> <span class="k">AS</span> <span class="n">artistAlbum</span>
  <span class="k">WHERE</span> <span class="n">artistAlbum</span><span class="p">.</span><span class="n">artist</span> <span class="o">=</span> <span class="n">album</span><span class="p">.</span><span class="n">artist</span>
<span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>The query finds all the latest albums from every artist (meaning if an artist releases 2 albums in 2019 but none afterwards, those albums appear).
It's already pretty complicated so lets write a common table expression which we can use later in the query:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="n">artistInfo</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">activeUntil</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">artist</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">year_of_release</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">album</span>
<span class="p">)</span>

<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">album</span>
<span class="k">JOIN</span> <span class="n">artistInfo</span> <span class="k">ON</span> <span class="p">(</span><span class="n">artist</span> <span class="o">=</span> <span class="n">artistInfo</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">year_of_release</span> <span class="o">=</span> <span class="n">artistInfo</span><span class="p">.</span><span class="n">activeUntil</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>More verbose, but hopefully you can see how this would scale a bit nicer. If we assume the data populating <code>artistInfo</code>
gets more complex, the query below doesn't need to grow in complexity.</p>
<hr>
<p>The catch here is now we're using joins,
but this actually has another added benefit to it - which we'll illustrate by explaining the query plan on these two queries.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">EXPLAIN</span> <span class="n">QUERY</span> <span class="n">PLAN</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">album</span>
<span class="k">WHERE</span> <span class="n">year_of_release</span> <span class="o">=</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">year_of_release</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">album</span> <span class="k">AS</span> <span class="n">artistAlbum</span>
  <span class="k">WHERE</span> <span class="n">artistAlbum</span><span class="p">.</span><span class="n">artist</span> <span class="o">=</span> <span class="n">album</span><span class="p">.</span><span class="n">artist</span>
<span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>id</th>
<th>parent</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>0</td>
<td>SCAN TABLE album</td>
</tr>
<tr>
<td>5</td>
<td>0</td>
<td>CORRELATED SCALAR SUBQUERY 1</td>
</tr>
<tr>
<td>10</td>
<td>5</td>
<td>SEARCH TABLE album AS artistAlbum</td>
</tr>
</tbody>
</table>
<p>Because the subquery is <code>CORRELATED</code> it runs once per row of album, which is expensive for large data sets.
The subsequent <code>SEARCH</code> comes from the <code>WHERE artistAlbum.artist = album.artist</code>, there's no index on the <code>album.artist</code>
column so it just has to search the table for a match. Now we'll check out the one using a common table expression.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">EXPLAIN</span> <span class="n">QUERY</span> <span class="n">PLAN</span>
<span class="k">WITH</span> <span class="n">artistInfo</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">activeUntil</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">artist</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">year_of_release</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">album</span>
<span class="p">)</span>

<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">album</span>
<span class="k">JOIN</span> <span class="n">artistInfo</span> <span class="k">ON</span> <span class="p">(</span><span class="n">artist</span> <span class="o">=</span> <span class="n">artistInfo</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">WHERE</span> <span class="n">year_of_release</span> <span class="o">=</span> <span class="n">artistInfo</span><span class="p">.</span><span class="n">activeUntil</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>id</th>
<th>parent</th>
<th>detail</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>0</td>
<td>MATERIALIZE 1</td>
</tr>
<tr>
<td>7</td>
<td>3</td>
<td>SEARCH TABLE album</td>
</tr>
<tr>
<td>23</td>
<td>0</td>
<td>SCAN SUBQUERY 1</td>
</tr>
<tr>
<td>25</td>
<td>0</td>
<td>SCAN TABLE album</td>
</tr>
</tbody>
</table>
<p>Now instead of the correlated subquery, we're materializing that subquery to start and then joining it with album. Materializing
just happens once so this query becomes a lot more performant.</p>
<hr>
<p>There's one other huge benefit to common table expressions, which is that you can do
recursion! They're harder to follow and potentially defeat &ldquo;easier to read and maintain&rdquo; but sometimes they're the simplest solution and worth
knowing. Here's a recursive query that comes in handy for splitting a single string into a table where each row is one word:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">WITH</span> <span class="k">RECURSIVE</span>
<span class="n">split_string</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="s1">&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">:</span><span class="k">input</span> <span class="o">|</span><span class="o">|</span> <span class="s1">&#39;</span><span class="s1"> </span><span class="s1">&#39;</span>
    <span class="k">UNION</span> <span class="k">ALL</span> <span class="k">SELECT</span>
      <span class="n">substr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">instr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s1"> </span><span class="s1">&#39;</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
      <span class="n">substr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">instr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s1"> </span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">split_string</span> <span class="k">WHERE</span> <span class="n">str</span> <span class="o">!</span><span class="o">=</span> <span class="s1">&#39;</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="k">SELECT</span> <span class="p">.</span><span class="p">.</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><p>To show how this works lets run it with <code>:input</code> = <code>&quot;hello recursive world&quot;</code>:</p>
<table>
<thead>
<tr>
<th>word</th>
<th>str</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>hello recursive world</td>
</tr>
<tr>
<td>hello</td>
<td>recursive world</td>
</tr>
<tr>
<td>recursive</td>
<td>world</td>
</tr>
<tr>
<td>world</td>
<td></td>
</tr>
</tbody>
</table>
<p>We're making heavy use of the <code>instr</code> function to find the next space, take the word before that and leave the remaining string. Recursive
queries work like a queue, the first part of the query (everything before <code>UNION ALL</code>) populates the queue initially, and
then the sqlite runtime pops off a row from the queue, runs the query after the <code>UNION ALL</code> using only that row, and pushes the results onto the
queue. Eventually <code>str</code> is empty so the query after <code>UNION ALL</code> pushes nothing onto the queue, so it ends. The results above are both the queue forming
and the table created at the end.</p>
<p>Since we only care about the words you just have to modify how you select from the query:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">word</span>
<span class="k">FROM</span> <span class="n">split_string</span>
<span class="k">WHERE</span> <span class="n">word</span> <span class="o">!</span><span class="o">=</span> <span class="s1">&#39;</span><span class="s1">&#39;</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>word</th>
</tr>
</thead>
<tbody>
<tr>
<td>hello</td>
</tr>
<tr>
<td>recursive</td>
</tr>
<tr>
<td>world</td>
</tr>
</tbody>
</table>
<p>Nice! Sometimes you want to be able to <code>JOIN</code> a runtime parameter for sqlite, and this is how I do it. Again it has the benefit of running once,
which can be a lot more performant than writing the query to use <code>WHERE ___ IN ____</code> sometimes.</p>

        </div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>This article is updated with 2020-05-13</span>
            </div>
            <div class="post-info-license">

            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md">


                        <span><a class="link-to-markdown" href="https://alecstrong.com/2020/05/cte/index.md" target="_blank"></a></span>


            </div>
            <div class="post-info-share">

                    <span>

        <a href="//twitter.com/share?url=https%3a%2f%2falecstrong.com%2f2020%2f05%2fcte%2f&amp;text=SQLite%20Helper%20Queries&amp;via=Strongolopolis" target="_blank" title="Share on Twitter">
            <i class="fab fa-twitter fa-fw"></i>
        </a>



        <a href="//reddit.com/submit?url=https%3a%2f%2falecstrong.com%2f2020%2f05%2fcte%2f&amp;title=SQLite%20Helper%20Queries" target="_blank" title="Share on Reddit">
            <i class="fab fa-reddit fa-fw"></i>
        </a>








</span>

            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section>

        </section>
        <section>
            <span><a href="javascript:window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="https://alecstrong.com/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">

            <a href="https://alecstrong.com/2020/02/multiple-dialects/" class="prev" rel="prev" title="Supporting Multiple Dialects in SQLDelight"><i class="fas fa-angle-left fa-fw"></i>Supporting Multiple Dialects in SQLDelight</a>


    </div>
</div>

        <div class="post-comment">




        </div>
    </article></div>
            </main>
            <footer class="footer">
    <div class="copyright">
        <div class="copyright-line">
            Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>
        <div class="copyright-line">
            <i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://alecstrong.com/">Alec Strong</a></span><span class="license">&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer>





















































































<script src="/js/lib/jquery/jquery.slim.min.min.js"></script>
<script src="/js/lib/lazysizes/lazysizes.min.min.js"></script>
<script src="/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js"></script><script>window.scroll = new SmoothScroll('[data-scroll]', {speed: 300, speedAsDuration: true});</script>


















<script src="/js/blog.min.js"></script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-156931611-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
        <a href="#" class="dynamic-to-top" id="dynamic-to-top" data-scroll><span>&nbsp;</span></a>
    </body>
</html>
